package hr.tom.lab.controller;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.MessageSource;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import hr.tom.lab.entity.DatabaseManager;
import hr.tom.lab.entity.MalwareObject;
import hr.tom.lab.entity.MessageConfig;
import hr.tom.lab.entity.MessageType;

/**
 * Controller class used for pages related to deleting entry.
 * 
 * @author Tom.K
 * 
 */
@Controller
public class DeleteController {

	@Autowired
	JdbcTemplate jdbcTemplate;

	@Autowired
	MessageSource messageSource;

	/**
	 * Generates "delete" template page.
	 * 
	 * @param model
	 *            Template model.
	 * @param id
	 *            Malware ID from DB.
	 * @return Template page "delete.html".
	 */
	@RequestMapping(value = "/delete/{id}")
	public String register(Model model, @PathVariable Integer id) {
		MalwareObject malware = DatabaseManager.getMalwareDetails(jdbcTemplate, id);
		model.addAttribute("malware", malware);
		return "delete";
	}

	/**
	 * Redirects to "/" or "/details/{id}" depending on success with deleting
	 * entry from DB.
	 * 
	 * @param model
	 *            Template model.
	 * @param redirectAttributes
	 *            Attributes to be applied on redirect page.
	 * @param id
	 *            Malware ID from DB.
	 * @param confirm
	 *            Check is deleting entry confirmed.
	 * @return Redirect to "/" if successful, otherwise redirects to
	 *         "/details/id".
	 */
	@RequestMapping(value = "/delete/{id}", method = RequestMethod.POST)
	public String addUser(Model model, RedirectAttributes redirectAttributes, @PathVariable Integer id,
			@RequestParam("confirm") Boolean confirm) {
		if (confirm) {
			if (DatabaseManager.deleteEntry(jdbcTemplate, id)) {
				MessageConfig.setMessage(redirectAttributes, messageSource, "message.delete.success", MessageType.INFO);
			} else {
				MessageConfig.setMessage(redirectAttributes, messageSource, "message.delete.failure", MessageType.INFO);
			}
		} else {
			return "redirect:/details/" + id;
		}
		return "redirect:/";
	}
}
